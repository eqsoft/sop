<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>gui.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/db.html">db</a></li>
            
                <li><a href="../classes/env.html">env</a></li>
            
                <li><a href="../classes/gui.html">gui</a></li>
            
                <li><a href="../classes/main.html">main</a></li>
            
                <li><a href="../classes/som.html">som</a></li>
            
                <li><a href="../classes/utils.html">utils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: gui.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * GUI class for SCORM-Offline-Manager and -Player
 *  
 * @class gui
 **/ 
&#x27;use strict&#x27;;

module.metadata = {
  &quot;stability&quot;: &quot;unstable&quot;
};

const {Cc, Ci, Cu, Cr, Cm} = require(&quot;chrome&quot;);
/**
 * @public
 * @event on
 **/
/**
 * @public
 * @event once
 **/
/**
 * @public
 * @method removeListener
 **/
var { emit, off, on, once } = require(&quot;sdk/event/core&quot;);
exports.on = on.bind(null, exports);
exports.once = once.bind(null, exports);
exports.removeListener = function removeListener(type, listener) {
	off(exports, type, listener);
};
exports.__exposedProps__ = {
	on 		: &quot;rw&quot;,
	removeListener	: &quot;rw&quot;
};

/**
 * sdk packages
 */
 
var data = require(&#x27;self&#x27;).data;
var system = require(&quot;sdk/system&quot;);
var windows = require(&quot;sdk/windows&quot;).browserWindows;
var winutils = require(&#x27;sdk/window/utils&#x27;);
var tabs = require(&quot;sdk/tabs&quot;);
//var tabutils = require(&quot;sdk/tabs/utils&quot;);
var file = require(&quot;sdk/io/file&quot;);
var net = require(&quot;sdk/net/url&quot;);

/** 
 * custom modules and variables
 */
var main = require(&quot;./main&quot;);
var utils = require(&quot;./utils&quot;);
var som = require(&quot;./som&quot;);
var db = require(&quot;./db&quot;);
var env	= require(&quot;./env&quot;);

var mtab = null; // manager tab (only one instance)
var mw = null; // unwrapped manager window (only one instance) 

var ps = {}; // player instances

var mts = { lms : &quot;&quot;, lm : &quot;&quot;} 	// manager templates, must be manually registered: see data/som/templates/manager/*.html
var pts = {}; 			// player templates, must be manually registered: see data/som/templates/player/*.html

main.on(&quot;startup&quot;, startup );
main.on(&quot;install&quot;, startup );
main.on(&quot;downgrade&quot;, downgrade );
windows.on(&quot;open&quot;,onWinOpen); // for event if manager or player is dragged to a new window
tabs.on(&quot;ready&quot;,onTabReady);
var prefs = require(&#x27;sdk/simple-prefs&#x27;).prefs;
require(&#x27;sdk/simple-prefs&#x27;).on(&quot;startSOM&quot;, onPrefStartSom);
require(&#x27;sdk/simple-prefs&#x27;).on(&quot;stopSOM&quot;, onPrefStopSom);
require(&#x27;sdk/simple-prefs&#x27;).on(&quot;resetSOM&quot;, onPrefResetSom);
 
som.on(&quot;allLmChanged&quot;,renderAllLm);
som.on(&quot;lmChanged&quot;,renderLm);

const maxReloadTries = 5;
var reloadTries = 0;

function startup() {
	if (prefs.autoStart) {
		utils.log(&quot;gui startup&quot;);
		if (mtab) {
			utils.log(&quot;already started&quot;);
			return;
		}
		openSomTab();
	}
}

function downgrade(load=false) {
	if (!load) { // comes from unload
		try {
			env.stop();
		}
		catch (e) {
			utils.err(e);
		}
	}
	else { // comes from new install
		var windows = require(&quot;sdk/windows&quot;).browserWindows;
		// this will stop rte env!
		for each (var tab in windows.activeWindow.tabs) {
			if (tab.title == env.globals.managerTitle || tab.title == env.globals.playerTitle) {
				utils.log(&quot;close tab &quot; + tab.title);
				tab.close();
			}
		}
		startup(); 
	}
}

function init(tab) {
	utils.log(&quot;init gui&quot;);
	switch (tab.title) {
		case env.globals.managerTitle :
			if (mtab) {
				utils.log(&quot;som already started.&quot;);
				tab.close();
				activateManager();
			}
			else {
				env.run(); 
				initManager(tab);
			}
			break;
		case env.globals.playerTitle :
			var params = getParams(tab.url);
			var id = params.client+&quot;_&quot;+params.obj_id;
			if (id in ps) { 
				utils.log(&quot;lm with id &quot; + id + &quot; is already running&quot;);
				tab.close();
				activatePlayer(id);
			}
			else {
				env.run();
				initPlayer(tab);
			}
			break;
		default :
			utils.log(&quot;external tab &quot; + tab.title + &quot;: no initialization&quot;);
	}
}

function initManager(tab) {
	utils.log(&quot;init manager&quot;);
	mtab = tab;
	if (prefs.pinTab) { // experimental
		tab.pin();
	}
	var jq = data.url(&quot;som/jquery/jquery.js&quot;);
	var bs = data.url(&quot;som/bootstrap/js/bootstrap.min.js&quot;);
	var mwin = winutils.getMostRecentBrowserWindow();
	getManagerTemplates();
	mw = mwin.content.wrappedJSObject;
	mw.som = som;
	mw.db = db;
	mw.utils = utils;
	mw.gui = managerFuncs;
	mw.addEventListener(&quot;load&quot;, onManagerLoad, true);
	mw.addEventListener(&quot;unload&quot;, onManagerUnload, true);
	var mworker = tab.attach( { &#x27;contentScriptFile&#x27; : [jq,bs] }); 
}

function initPlayer(tab) {
	utils.log(&quot;init player&quot;);
	if (reloadTries === maxReloadTries) {
		utils.err(&quot;max reload tries reached, sorry something goes wrong...&quot;);
		return;
	}
	
	var brWin = winutils.getMostRecentBrowserWindow();
	var wrapWin = brWin.content.wrappedJSObject;
	
	if (wrapWin.document.title != env.globals.playerTitle) {
		utils.log(&quot;window BUG: must reload tab...&quot;);
		tab.activate();
		tab.window.activate();
		reloadTries ++
		tab.reload();
		return;
	}
	reloadTries = 0;
	var id = getId(getParams(tab.url));
	
	if (utils.findIn(ps,id)) {
		utils.log(&quot;player instance exists: &quot; + id);
		tab.close();
		ps[id].win.activate();
		ps[id].tab.activate(); // ToDo: if opened in new window activate window first
		return;
	}
	wrapWin.som = som;
	wrapWin.db = db;
	wrapWin.utils = utils;
	wrapWin.gui = playerFuncs;
	wrapWin.addEventListener(&quot;load&quot;, function() { onPlayerLoad(id) }, false);
	wrapWin.addEventListener(&quot;unload&quot;, function() { onPlayerUnload(id) }, false);
	ps[id] = {
		id 		: id,
		tab		: tab,
		brWin		: brWin,
		wrapWin		: wrapWin
	}
	getPlayerTemplates(); 
}

function openSomTab() {
	var url = data.url(&quot;som/som.html&quot;);
	tabs.open({ url: url });
}

function getMTab() {
	return mtab;
}

function getPs() {
	return ps;
}
 
function activateManager() {
	utils.log(&quot;activate Manager&quot;);
	try {
		mtab.activate();
		mtab.window.activate();
	}
	catch(e) {
		utils.err(e);
	}
}

function activatePlayer(id) {
	utils.log(&quot;activate Player&quot;);
	try {
		ps[id].tab.activate();
		ps[id].tab.window.activate();
	}
	catch(e) {
		utils.err(e);
	}
}

/**
 * prefs events
 */ 

function onPrefStartSom() {
	utils.log(&quot;onPrefStartSom&quot;);
	onPrefStopSom();
	openSomTab();
}

function onPrefStopSom() {
	utils.log(&quot;onPrefStopSom&quot;); 
	if (mtab) {
		mtab.close();
		mtab = null;
		mw = null;
	}
	env.stop();
}

function onPrefResetSom() {
	utils.log(&quot;onPrefResetSom&quot;);
	onPrefStopSom();
	env.cleanProfileData();
	env.initIO();
	env.populateProfile();
	openSomTab();
}

/**
 * manager and player events 
 */
  
function onManagerLoad() {
	utils.log(&quot;manager ready&quot;);
	var lms = som.getAllLm(); // this will trigger som event lmsChanged
	for each (var p in ps) {
		renderLmStatus(p.id,&quot;running&quot;);
	}
}

function onManagerUnload() {
	utils.log(&quot;manager closed&quot;);
	mw = null;
	mtab = null;
	emit(exports,&quot;managerUnload&quot;);
}

function onPlayerLoad(id) {
	utils.log(&quot;player ready: &quot; + id);
	renderLmStatus(id,&quot;running&quot;);
	emit(exports, &quot;playerLoad&quot;);
}

function onPlayerUnload(id) {
	utils.log(&quot;gui emit playerUnload&quot;);
	delete ps[id];
	renderLmStatus(id);
	emit(exports,&quot;playerUnload&quot;,id);
	
}

/**
 * window events
 */ 
 
function onWinOpen(win) { // check if a player window was dragged to a new window
	utils.log(&quot;gui onWinOpen&quot;);
	var brWin = winutils.getMostRecentBrowserWindow();
	brWin.setTimeout(function () { checkNewWindow(win.tabs[0],brWin) }, 1000);
}

function onWinClose(window) {
	utils.log(&quot;gui onWinClose&quot;);
}

function onWinActivate(window) {
	utils.log(&quot;gui onWinActivate&quot;);
}

function onWinDeactivate(window) {
	utils.log(&quot;gui onWinDeactivate&quot;);
}

/**
 * tab events 
 */
  
function onTabReady(tab) {
	utils.log(&quot;tab ready: &quot; + tab.title);
	init(tab); 
}

function onTabClose(tab) { // Buggy
	utils.log(&quot;tab close&quot;);
}

function onTabActivate(tab) {
	utils.log(&quot;tab activate&quot;);  
}

function onTabDeactivate(tab) {
	utils.log(&quot;tab deactivate&quot;);
}

/**
 * misc functions
 */ 

function checkNewWindow(tab,brWin) {
	utils.log(&quot;checkNewWindow: &quot; + tab.title);
	for each (var p in ps) {		
		if (p.tab.title === undefined) { // was copied to the new window (puhhh...)
			utils.log(&quot;new win and tab for existing player&quot;);
			ps[p.id][&quot;tab&quot;] = tab;
			ps[p.id][&quot;brWin&quot;] = brWin;
		}
	}
}

function getId(params) {
	try {
		return params.client + &quot;_&quot; + params.obj_id;
	}
	catch(e) {
		utils.err(e);
	}
}

function getManagerParams() {
	return JSON.stringify(getParams(mw));
}

function getPlayerParams(win) {
	return JSON.stringify(getParams(win));
}

function getParams(win) { // window object or url string
	var w = winutils.getMostRecentBrowserWindow();
	var qs = {};
	var queryString;
	queryString = (typeof win === &quot;string&quot;) ? win.split(&quot;\?&quot;)[1] : win.document.location.search.slice(1);
	var re = /([^&amp;=]+)=([^&amp;]*)/g;
	var m;
	while (m = re.exec(queryString)) {
		qs[w.decodeURIComponent(m[1])] = w.decodeURIComponent(m[2]);
	}
	return qs;
}

/**
 * templates
 */

function getManagerTemplates() {
	for each (var tmp in Object.keys(mts)) {
		var u = data.url(&quot;som/templates/manager/&quot; + tmp + &quot;.html&quot;);
		net.readURI(u, {sync: true, charset : &quot;UTF-8&quot;}).then(function(c) { mts[tmp] = c } );
	}
}

function getPlayerTemplates() {
	// no templates
}

function renderAllLm() { 
	if (!mw) {
		return;
	}
	utils.log(&quot;renderAllLm&quot;); // ToDo: Problem of second installation if player is open lm will be not rendered: empty page ?? 
	var lms = som.getLmsObj();
	var str = &quot;&quot;;
	var tmp = mts.lms;
	for each (var lm in lms) {
		var id = lm.client + &quot;_&quot; + lm.obj_id;
		var player = (lm.scorm_version == &quot;1.2&quot;) ? &quot;player12.htm&quot; : &quot;player2004.html&quot;
		var url = &quot;http://localhost:50012/&quot; + player + &quot;?client=&quot; + lm.client + &quot;&amp;obj_id=&quot; + lm.obj_id;
		var s = tmp.replace(/__\#VAR_LINK__/g, url);
		s = s.replace(/__\#VAR_CRSID__/g, id);
		s = s.replace(/__\#VAR_TITLE__/g,lm.title);
		s = s.replace(/__\#VAR_CRSDETAILS__/g,&quot;detail_&quot; + lm.client + &quot;_&quot; + lm.obj_id);
		var st = (lm.status) ? lm.status.replace(&quot;trac_&quot;,&quot;&quot;) : &quot;not_attempted&quot;;
		s = s.replace(/__\#VAR_STATUSICON__/g,&quot;images/&quot; + st + &quot;.png&quot;);
		s = s.replace(/__\#VAR_STATUSTITLE__/g,st);
		str += s;
		str = renderLm(id,str);
	}
	var elLm = mw.document.getElementById(&quot;acLm&quot;);
	elLm.innerHTML = str; 
}

function renderLm(id,str=false) {
	if (!mw) {
		return;
	}
	var lms = som.getLmsObj();
	var lm = lms[id];
	var tmp = mts.lm;
	tmp = tmp.replace(/__\#VAR_DESCRIPTION__/g,lm.description);
	var tt = (lm.total_time !== &quot;&quot;) ? mw.decodeURIComponent(lm.total_time) : &quot;&quot;;
	tmp = tmp.replace(/__\#VAR_TOTALTIME__/g,tt);
	
	if (str) { // comming from renderAllLm
		return str.replace(/__\#TMP_LM__/g,tmp); 
	}
	else {
		var elLmDetail = mw.document.getElementById(&quot;aciLm&quot;);
		elLmDetail.innerHTML = tmp;
	}
}

function renderLmStatus(id,status) {
	if (!mw) {
		return;
	}
	utils.log(&quot;renderLmStatus: &quot; + id);
	if (!status) {
		var lms = som.getLmsObj();
		status = lms[id].status.replace(&quot;trac_&quot;,&quot;&quot;);
	}
	var img = mw.document.getElementById(&quot;status_&quot; + id);
	img.src = &quot;images/&quot; + status + &quot;.png&quot;;
}

/**
 * gui actions
 */
  
function getData(statement, params, asRecordObject) {
	return db.getData(statement, params, false, asRecordObject);
}

function setData(statement, params) {
	return db.setData(statement, params)
}

var managerFuncs = {
	getManagerParams : getManagerParams,
	__exposedProps__ : {
		getManagerParams : &quot;r&quot;
	}
} 

var playerFuncs = {
	getParams	: getParams,
	getPlayerParams : getPlayerParams,
	getData		: getData,
	setData		: setData,	
	__exposedProps__ : {
		getParams : &quot;r&quot;,
		getPlayerParams : &quot;r&quot;,
		getData : &quot;r&quot;,
		setData : &quot;r&quot;
	}
}

/* late binding of exports and exposed props */
exports.getParams = getParams;
exports.getMTab = getMTab;
exports.getPs = getPs;
exports.activateManager = activateManager;
exports.activatePlayer = activatePlayer;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
